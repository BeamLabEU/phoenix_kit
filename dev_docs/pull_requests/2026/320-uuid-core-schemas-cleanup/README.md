# PR #320: Update core PhoenixKit schemas and Referrals to new UUID standard

**Author**: @mdon
**Reviewer**: Claude Opus 4.5
**Status**: âœ… Merged
**Commit**: `86eface6`
**Date**: 2026-02-05

## Goal

Complete the UUID migration across all 69 PhoenixKit schemas by removing redundant `maybe_generate_uuid` functions from core schemas and the Referrals module, and adding `read_after_writes: true` to ensure DB-generated UUIDs are properly read back by Ecto. This is the final PR in the UUID standardization effort (PRs #311-#320).

## What Was Changed

### Files Modified (11 files, +38/-202)

| File | Change |
|------|--------|
| `lib/phoenix_kit/users/auth/user.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` from 2 changesets |
| `lib/phoenix_kit/users/auth/user_token.ex` | Add `read_after_writes: true`, remove 3 `UUIDv7.generate()` calls from struct builders |
| `lib/phoenix_kit/users/role.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/phoenix_kit/users/role_assignment.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/phoenix_kit/users/admin_note.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/phoenix_kit/users/oauth_provider.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/phoenix_kit/audit_log/entry.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/phoenix_kit/settings/setting.ex` | Add `read_after_writes: true`, remove `maybe_generate_uuid` |
| `lib/modules/referrals/referrals.ex` | Remove redundant `maybe_generate_uuid` |
| `lib/modules/referrals/schemas/referral_code_usage.ex` | Remove redundant `maybe_generate_uuid` |
| `dev_docs/uuid_module_status.md` | Update status to reflect completion |

### Schema Changes

All 10 schemas follow the same pattern:

```elixir
# Before
schema "table_name" do
  field :uuid, Ecto.UUID
  # ...
end

defp maybe_generate_uuid(changeset) do
  case get_field(changeset, :uuid) do
    nil -> put_change(changeset, :uuid, UUIDv7.generate())
    _ -> changeset
  end
end

# After
schema "table_name" do
  field :uuid, Ecto.UUID, read_after_writes: true
  # ...
end

# maybe_generate_uuid function removed entirely
```

### UserToken Special Case

UserToken had additional cleanup - removing `uuid: UUIDv7.generate()` from struct builders:

```elixir
# Before
user_token = %UserToken{
  uuid: UUIDv7.generate(),
  token: token,
  context: "session",
  # ...
}

# After
user_token = %UserToken{
  token: token,
  context: "session",
  # ...
}
```

## Implementation Details

### 1. DB-Generated UUID Pattern

The `read_after_writes: true` option tells Ecto to issue a `RETURNING` clause after INSERT operations, reading back the UUID that was generated by the database's DEFAULT constraint:

```sql
-- Database generates UUID via DEFAULT
INSERT INTO phoenix_kit_users (email, ...) VALUES ($1, ...)
RETURNING id, uuid, ...
```

### 2. Prerequisite: Database Migrations

This pattern requires that database migrations already have UUID DEFAULT constraints. The existing migrations (V1-V31) include:

```sql
uuid UUID DEFAULT uuid_generate_v7() NOT NULL
```

### 3. Schemas Updated

| Category | Schemas | Count |
|----------|---------|-------|
| Users | User, UserToken, Role, RoleAssignment, AdminNote, OAuthProvider | 6 |
| AuditLog | Entry | 1 |
| Settings | Setting | 1 |
| Referrals | ReferralCode, ReferralCodeUsage | 2 |
| **Total** | | **10** |

### 4. UUID Migration Complete

After this PR, all 69 schemas use standardized UUID patterns:

| Pattern | Schemas | Description |
|---------|---------|-------------|
| New Standard | 41 | `read_after_writes: true` with DB-generated UUIDs |
| Native UUID PK | 28 | `@primary_key {:id, UUIDv7, autogenerate: true}` |
| Old Pattern | 0 | None remaining |

## Review Assessment

### Positives

1. **Completes migration effort** - Final PR in series (#311-#320), all schemas now standardized
2. **Significant code reduction** - Net deletion of 164 lines of boilerplate
3. **Consistent pattern** - All 69 schemas now follow the same UUID approach
4. **Proper Ecto usage** - `read_after_writes: true` is the correct way to handle DB-generated values
5. **Documentation updated** - `uuid_module_status.md` reflects completion status
6. **Clean diffs** - Each file change is minimal and focused

### Technical Verification

- **User schema**: Both `registration_changeset/2` and `guest_checkout_changeset/2` properly updated
- **UserToken**: All 3 struct builders (session, email token, magic link) cleaned up
- **Referrals**: Redundant pattern removed (had `read_after_writes` but also `maybe_generate_uuid`)

### No Concerns

This is a straightforward cleanup PR with no architectural changes or new features. The pattern is well-established and tested across the codebase.

## Testing

- [x] Pre-commit checks passed (format, credo)
- [x] Compilation successful
- [x] Pattern already proven in 59 other schemas
- [x] Database migrations have required DEFAULT constraints

## Related

- **Previous PRs in series**:
  - PR #311: AI module UUID update
  - PR #312: Publishing module UUID update
  - PR #313: Entities module UUID update
  - PR #314: Billing module UUID update
  - PR #315: Shop, Emails, Sync modules UUID update
  - PR #316: Legal module UUID update
  - PR #317: Referrals module UUID update
- **Documentation**: `dev_docs/uuid_module_status.md`
- **UUID Utility**: `lib/phoenix_kit/utils/uuid.ex`
- **CLAUDE.md**: "Adding UUID Fields to Existing Schemas" section
